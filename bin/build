#!/usr/bin/env bash

source $(dirname $0)/../lib/bowline/bowline
assert_proxy

if [ ! -d .ssh ];then
  echo "# Making keys"
  mkdir .ssh
  # @TODO move this to inside the sync container, probably docker-entrypoint
  ssh-keygen -q -N '' -C bowline-sync -f .ssh/id_rsa
  cp -v .ssh/id_rsa.pub .ssh/authorized_keys
  echo "StrictHostKeyChecking no" >> .ssh/config
fi

echo "# STARTING CONTAINERS"
$DCOMPOSE up -d --no-recreate

# File sync prep
docker cp .ssh ${SLUG}_filestore_1:/root
docker cp .ssh ${SLUG}_sync_1:/root
docker exec -ti ${SLUG}_filestore_1 chown -R data: /home/data
docker exec -ti ${SLUG}_filestore_1 chown -R data: /var/www

EXIT=$?
echo -e "\033[m Exit Status: $EXIT"

bowline
exit $EXIT
